pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- LightYourPath
-- by hav
--

-- Data
#include source/business/utils/hitbox.p8
#include source/business/utils/animation.p8
#include source/business/player.p8


player = Player:new(5,0,8,100,8,8,0.8,0,0.3,-4,true,0,"IDLE")
endFlag    = {x = 125, y = 104, w = 1, h = 5}
platforms = {}
grounds   = {}
discovered = {}
lightLevel = true


-- Game update function 60 FPS

function _update60()
  player:Movement()
  checkCollision()
  checkCollisionGround()
  checkEnd()
end

-- Game drawing functions 

--Pico8 function
function _draw()

  if lightLevel then

    cls()

    drawGround()

    drawPlatforms()
  
    drawPlayer()
  
    drawEnd()

    print('score: '..player.score, 5, 1, 7)
    print('vies: '..player.health, 5, 10, 8)

  else

    cls()

    drawGround()

    drawDiscovered()
  
    drawPlayer()
  
    drawEnd()

    print('score: '..player.score, 5, 1, 7)
    print('vies: '..player.health, 5, 10, 8)
  end
end

-- Fonction de verification de collision
function checkCollision()
  -- Collision avec les plateformes
  for i = 1, #platforms do
    local platform = platforms[i]

    if player.x + player.w >= platform.x and player.x <= platform.x + platform.w and
       player.y + player.h >= platform.y and player.y <= platform.y  then
      -- Collision detectee : le joueur est sur une plateforme
       player.y = platform.y - player.h - 1
       player.vy = 0
       player.can_jump = true
       add(discovered,platform)
    end  
  end
end

-- Fonction de verification de collision
function checkCollisionGround()
  -- Collision avec les plateformes
  for i = 1, #grounds do
    local ground = grounds[i]

    if player.x + player.w >= ground.x and player.x <= ground.x + ground.w and
       player.y + player.h >= ground.y and player.y <= ground.y + ground.h  then
      -- Collision detectee : le joueur est sur une plateforme
       player.y = ground.y - player.h - 1
       player.vy = 0
       player.can_jump = true
    end  
  end
end


function checkEnd()
  if player.x + player.w >= endFlag.x and player.x <= endFlag.x + endFlag.w and
       player.y + player.h >= endFlag.y and player.y <= endFlag.y + endFlag.h  then
    lightLevel = not lightLevel
    player.x = 4
    player.y = 110
    player.score += 1
    discovered = {}
  end
end

-- Fonction de rendu du joueur
function drawPlayer()
   --Setting the current animation sprite
   player:Animate()
   --Draw the sprite
   spr(player.sprite,player.x, player.y)
end

--Fonction de dessin de l arrivee du niveau

function drawEnd()
  rectfill(endFlag.x,endFlag.y,endFlag.x + endFlag.w, endFlag.y + endFlag.h, 8) -- Rectangle arrivee 
end

-- Fonction de rendu des plateformes
function drawPlatforms()
  for i = 1, #platforms do
    local platform = platforms[i]
    rectfill(platform.x, platform.y, platform.x + platform.w, platform.y + platform.h, 7)  -- Rectangle plateforme
  end
end

-- Fonction de rendu des plateformes
function drawDiscovered()
  for i = 1, #discovered do
    local platform = discovered[i]
    rectfill(platform.x, platform.y, platform.x + platform.w, platform.y + platform.h, 7)  -- Rectangle plateforme
  end
end

function drawGround()
  for i = 1 , #grounds do
    local ground = grounds[i]
    rectfill(ground.x, ground.y, ground.x + ground.w, ground.y + ground.h, 7)  -- Rectangle plateforme
  end
end


-- Fonction d'ajout d'une plateforme
function addPlatform(x, y, w, h)
    local platform = {x = x, y = y, w = w, h = h}
    add(platforms, platform)
  end

function addGround(x, y, w, h)
    local ground = {x = x, y = y, w = w, h = h}
    add(grounds, ground)
  end
  

-- Appel de la fonction addPlatform pour ajouter les plateformes
addGround(0, 110, 15, 20)  -- Plateforme sol 1
addGround(115, 110, 15, 20)  -- Plateforme sol 2

addPlatform(5, 75, 16, 2)  -- Plateforme intermediaire
addPlatform(39, 105, 32, 2)  -- Plateforme intermediaire
addPlatform(38, 65, 32, 2)  -- Plateforme intermediaire
addPlatform(95, 50, 8, 2)  -- Plateforme intermediaire

__gfx__
00111100111111001111110011111100001111000011111100111111001111110011110000111100000000000000000000000000000000000000000000000000
01111110111111101111111011111110011111100111111101111111011111110111111001111110000000000000000000000000000000000000000000000000
011fff10111fff10111fff10111fff1001fff11001fff11101ffff1101ffff10011fff1001fff110000000000000000000000000000000000000000000000000
01fcfc1011fcfc0001fcfc1011fcfc0001cfcf1001cfcf1101cfcf1101cfcf1101fcfc1001cfcf10000000000000000000000000000000000000000000000000
00ffef0000ffff0000ffff0000ffef0000feff0000ffff0000ffff0000feff0070ffef0000feff00000000000000000000000000000000000000000000000000
002222000f2222000f2222000f22220000222200002222f0002222f0002222f00022220770222207000000000000000000000000000000000000000000000000
00999900009999000099990000999900009999000099990000999900009999007099997007999707000000000000000000000000000000000000000000000000
00f00f0000f00f000f000f0000f0f00000f00f0000f00f0000f000f00f000f000777777077777770000000000000000000000000000000000000000000000000
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000077007700770777077700000000077700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000700070007070707070000700000070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000777070007070770077000000000070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000007070007070707070000700000070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000770007707700707077700000000077700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000808088808880088000000000888088800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000808008008000800008000000808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000808008008800888000000000888088800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000888008008000008008000000008000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000080088808880880000000000008000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777777000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777777000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000777777777000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000001111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011fff100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000001fcfc100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000880
0000000000ffef000000000000000000000000077777777777777777777777777777777700000000000000000000000000000000000000000000000000000880
00000000002222000000000000000000000000077777777777777777777777777777777700000000000000000000000000000000000000000000000000000880
00000000009999000000000000000000000000077777777777777777777777777777777700000000000000000000000000000000000000000000000000000880
0000000000f00f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000880
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000880
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777
77777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007777777777777

__sfx__
00050000000001d05019050140500f0500a0500605004050030500105000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000400000f15011150141501715000500005000060000500006000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500
001000002775023750217501f7501d7501b750187501675013750107500f7500e7500b75007750057500035000350003500670005700047000370002700017000670004700027000070000700000000000000000
